{"componentChunkName":"component---src-templates-blog-post-js","path":"/2020/kafka-butterfly/2020-12-04-kafka-in-butterfly/","result":{"data":{"site":{"siteMetadata":{"title":"Blog of Badal Sarkar"}},"markdownRemark":{"id":"98165466-078a-52ba-837c-0b8f560a3879","excerpt":"As part of release\n0.4,\nI am working on implementing a feature in\nPayPal/Butterfly project. The feature is\nfollowing-  What this means is that the logging…","html":"<p>As part of <a href=\"https://github.com/Seneca-CDOT/topics-in-open-source-2020/wiki/release-0.4\">release\n0.4</a>,\nI am working on implementing a feature in\n<a href=\"https://github.com/paypal/butterfly\">PayPal/Butterfly</a> project. The feature is\nfollowing-</p>\n<p><span\n      class=\"gatsby-resp-image-wrapper\"\n      style=\"position: relative; display: block; margin-left: auto; margin-right: auto; max-width: 630px; \"\n    >\n      <a\n    class=\"gatsby-resp-image-link\"\n    href=\"/static/d547ef2afa0a4fe9ef05a55bdb61de69/434c7/butterflyKafka.png\"\n    style=\"display: block\"\n    target=\"_blank\"\n    rel=\"noopener\"\n  >\n    <span\n    class=\"gatsby-resp-image-background-image\"\n    style=\"padding-bottom: 5.69620253164557%; position: relative; bottom: 0; left: 0; background-image: url('data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAABQAAAABCAYAAADeko4lAAAACXBIWXMAAAsSAAALEgHS3X78AAAAOklEQVQI143DQQ6AIAwAQf7/ut6BAo0JKng0gJf1C0wy7uydoIWQCl4zMRnZDup1I7Eh+jDmxzvW1h/ANEuJ0HmPoQAAAABJRU5ErkJggg=='); background-size: cover; display: block;\"\n  ></span>\n  <img\n        class=\"gatsby-resp-image-image\"\n        alt=\"Butterfly new features\"\n        title=\"Butterfly new features\"\n        src=\"/static/d547ef2afa0a4fe9ef05a55bdb61de69/f058b/butterflyKafka.png\"\n        srcset=\"/static/d547ef2afa0a4fe9ef05a55bdb61de69/c26ae/butterflyKafka.png 158w,\n/static/d547ef2afa0a4fe9ef05a55bdb61de69/6bdcf/butterflyKafka.png 315w,\n/static/d547ef2afa0a4fe9ef05a55bdb61de69/f058b/butterflyKafka.png 630w,\n/static/d547ef2afa0a4fe9ef05a55bdb61de69/40601/butterflyKafka.png 945w,\n/static/d547ef2afa0a4fe9ef05a55bdb61de69/78612/butterflyKafka.png 1260w,\n/static/d547ef2afa0a4fe9ef05a55bdb61de69/434c7/butterflyKafka.png 1381w\"\n        sizes=\"(max-width: 630px) 100vw, 630px\"\n        style=\"width:100%;height:100%;margin:0;vertical-align:middle;position:absolute;top:0;left:0;\"\n        loading=\"lazy\"\n      />\n  </a>\n    </span></p>\n<p>What this means is that the logging framework of Butterfly will use\n<a href=\"http://kafka.apache.org/\">Kafka</a> to do\nsome processing on the log messages. To understand this lets first see what is\nKafka.</p>\n<h3>Apache Kafka</h3>\n<blockquote>\n<p>Apache Kafka is an open-source distributed event streaming platform used by\nthousands of companies for high-performance data pipelines, streaming\nanalytics, data integration, and mission-critical applications.</p>\n</blockquote>\n<p>As it is mentioned above, <a href=\"http://kafka.apache.org/\">Kafka</a> is an event\nstreaming platform. Event streaming\nmeans capturing data from events and storing those durably for further\nprocessing. In simple term, Kafka consists of servers and clients. Clients send\nand receive data to/from server. The client that sends data to the server is\ncalled producer and the client that retrieves data from server is called\nconsumer. Producers and consumers are fully decoupled. Producers doesn’t know\nwho is going to consume the data. Again produced data can be consumed by many\nconsumers. You can read more about Kafka <a href=\"http://kafka.apache.org/intro\">here</a>.</p>\n<h3>Butterfly and Kafka</h3>\n<p>The following diagram illustrates how Butterfly will use Kafka.</p>\n<p><span\n      class=\"gatsby-resp-image-wrapper\"\n      style=\"position: relative; display: block; margin-left: auto; margin-right: auto; max-width: 630px; \"\n    >\n      <a\n    class=\"gatsby-resp-image-link\"\n    href=\"/static/3a4a047d6513b9d22923de69e0b0fbbc/a1253/butterflyKafkaArchi.png\"\n    style=\"display: block\"\n    target=\"_blank\"\n    rel=\"noopener\"\n  >\n    <span\n    class=\"gatsby-resp-image-background-image\"\n    style=\"padding-bottom: 46.835443037974684%; position: relative; bottom: 0; left: 0; background-image: url('data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAABQAAAAJCAYAAAAywQxIAAAACXBIWXMAAAsSAAALEgHS3X78AAABMElEQVQoz41S2Y6DMAzk/3+wbB9KOSTOcJSQBGiZtc0GVeyhtTRyzsmMnQCn2LZNwDHPM6y1cM4J/NjvczbGyBpnax0CT/AOjnVd5eDr9cLz+RTw3jhqubgsC8qyxO12w/X6gXsUIUkyBD8p5OALrPCsWk8Gk2CS/aZpEScp8rxE1z8Q8KKHc/NBzMo84XsY44hEoaobmTMx3+NH2FFQFAWyLKMXchRFSeMcSrU0L+Sw1hoR2UnT9KhTdE9oLUbX9aiqCpfLBXVd0XxA0PeDyGbUR1Zo205ss1XOjF2RwTA8BFxnpTp6IKZ61uiHkZuCbw35y7LWk6i0ZG8vgZGG7T9g/l9TzoSTsaK0aRpSqBCGoYzF8m/fhvP01VFDBB5tO2Ahq/6fdlSyOE6plkz4wCcC6LqHzvhy0AAAAABJRU5ErkJggg=='); background-size: cover; display: block;\"\n  ></span>\n  <img\n        class=\"gatsby-resp-image-image\"\n        alt=\"Butter use of Kafka\"\n        title=\"Butter use of Kafka\"\n        src=\"/static/3a4a047d6513b9d22923de69e0b0fbbc/f058b/butterflyKafkaArchi.png\"\n        srcset=\"/static/3a4a047d6513b9d22923de69e0b0fbbc/c26ae/butterflyKafkaArchi.png 158w,\n/static/3a4a047d6513b9d22923de69e0b0fbbc/6bdcf/butterflyKafkaArchi.png 315w,\n/static/3a4a047d6513b9d22923de69e0b0fbbc/f058b/butterflyKafkaArchi.png 630w,\n/static/3a4a047d6513b9d22923de69e0b0fbbc/a1253/butterflyKafkaArchi.png 657w\"\n        sizes=\"(max-width: 630px) 100vw, 630px\"\n        style=\"width:100%;height:100%;margin:0;vertical-align:middle;position:absolute;top:0;left:0;\"\n        loading=\"lazy\"\n      />\n  </a>\n    </span></p>\n<p>As the above diagram shows, the loggers will send log messages to the Kafka\nserver and those messages will be consumed by different consumers like storing\nto database, sending to browser etc. To understand how logging is working in\nButterfly you can read\n<a href=\"https://badalsarkar.ca/blog-opensource/opensource/new-feature-butterfly/\">this</a>\npost.</p>\n<p>There are basically three tasks to implement this architecture.</p>\n<ul>\n<li>Configure Kafka server</li>\n<li>Configure producer</li>\n<li>Configure consumers</li>\n</ul>\n<p>Configuring consumers is not part of this feature. So, I need to do first two\ntasks.</p>\n<h3>Configuring producer</h3>\n<p>Configuring producer is easier among the two tasks because\n<a href=\"https://logging.apache.org/log4j/2.x/\">Log4j2</a>, logging framework\nused by Butterfly, <a href=\"https://logging.apache.org/log4j/2.x/manual/appenders.html#KafkaAppender\">provides an appender that will send log messages to Kafka\nserver</a>.\nI just need to add that appender to the Log4j2 configuration file. So, I\nadded the following code to the configuration file-</p>\n<div class=\"gatsby-highlight\" data-language=\"xml\"><pre style=\"counter-reset: linenumber NaN\" class=\"language-xml line-numbers\"><code class=\"language-xml\"><span class=\"token tag\"><span class=\"token tag\"><span class=\"token punctuation\">&lt;</span>Appenders</span><span class=\"token punctuation\">></span></span>\n  <span class=\"token tag\"><span class=\"token tag\"><span class=\"token punctuation\">&lt;</span>Kafka</span> <span class=\"token attr-name\">name</span><span class=\"token attr-value\"><span class=\"token punctuation attr-equals\">=</span><span class=\"token punctuation\">\"</span>Kafka<span class=\"token punctuation\">\"</span></span> <span class=\"token attr-name\">topic</span><span class=\"token attr-value\"><span class=\"token punctuation attr-equals\">=</span><span class=\"token punctuation\">\"</span>log-message<span class=\"token punctuation\">\"</span></span><span class=\"token punctuation\">></span></span>\n    <span class=\"token tag\"><span class=\"token tag\"><span class=\"token punctuation\">&lt;</span>PatternLayout</span> <span class=\"token attr-name\">pattern</span><span class=\"token attr-value\"><span class=\"token punctuation attr-equals\">=</span><span class=\"token punctuation\">\"</span>[%d{HH:mm:ss.SSS}] [%-4level] %msg%n<span class=\"token punctuation\">\"</span></span> <span class=\"token punctuation\">/></span></span>\n      <span class=\"token tag\"><span class=\"token tag\"><span class=\"token punctuation\">&lt;</span>Property</span> <span class=\"token attr-name\">name</span><span class=\"token attr-value\"><span class=\"token punctuation attr-equals\">=</span><span class=\"token punctuation\">\"</span>bootstrap.servers<span class=\"token punctuation\">\"</span></span><span class=\"token punctuation\">></span></span>{butterflyserver:port}<span class=\"token tag\"><span class=\"token tag\"><span class=\"token punctuation\">&lt;/</span>Property</span><span class=\"token punctuation\">></span></span>\n  <span class=\"token tag\"><span class=\"token tag\"><span class=\"token punctuation\">&lt;/</span>Kafka</span><span class=\"token punctuation\">></span></span>\n<span class=\"token tag\"><span class=\"token tag\"><span class=\"token punctuation\">&lt;/</span>Appenders</span><span class=\"token punctuation\">></span></span>\n\n<span class=\"token tag\"><span class=\"token tag\"><span class=\"token punctuation\">&lt;</span>Root</span> <span class=\"token attr-name\">level</span><span class=\"token attr-value\"><span class=\"token punctuation attr-equals\">=</span><span class=\"token punctuation\">\"</span>ERROR<span class=\"token punctuation\">\"</span></span><span class=\"token punctuation\">></span></span>\n  <span class=\"token tag\"><span class=\"token tag\"><span class=\"token punctuation\">&lt;</span>AppenderRef</span> <span class=\"token attr-name\">ref</span><span class=\"token attr-value\"><span class=\"token punctuation attr-equals\">=</span><span class=\"token punctuation\">\"</span>FILE<span class=\"token punctuation\">\"</span></span> <span class=\"token punctuation\">/></span></span>\n  <span class=\"token tag\"><span class=\"token tag\"><span class=\"token punctuation\">&lt;</span>AppenderRef</span> <span class=\"token attr-name\">ref</span><span class=\"token attr-value\"><span class=\"token punctuation attr-equals\">=</span><span class=\"token punctuation\">\"</span>Kafka<span class=\"token punctuation\">\"</span></span> <span class=\"token punctuation\">/></span></span>\n<span class=\"token tag\"><span class=\"token tag\"><span class=\"token punctuation\">&lt;/</span>Root</span><span class=\"token punctuation\">></span></span></code><span aria-hidden=\"true\" class=\"line-numbers-rows\" style=\"white-space: normal; width: auto; left: 0;\"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></pre></div>\n<p>This configuration is simple. The appender is an instance <a href=\"https://logging.apache.org/log4j/2.x/log4j-core/apidocs/org/apache/logging/log4j/core/appender/mom/kafka/KafkaAppender.html\">KafkaAppender\nclass</a>.\nIt connects to the Kafka server using the property <code class=\"language-text\">bootstrap.servers</code>. Once the\nserver is implemented this value will be populated. Next this appender is\nattached to the root logger. Now, every time root logger logs a message, it will\nbe picked up by Kafka appender and sent to the server.</p>\n<p>Next step is to configure the server. I will write about it next week.</p>","frontmatter":{"title":"Implementing Kafka in PayPal/Butterfly","date":"December 05, 2020","description":null}},"previous":{"fields":{"slug":"/2020/testing-ci-workflow/2020-11-27-testing-and-ci-workflow-blink/"},"frontmatter":{"title":"Implementing Testing and CI Workflow in Blink"}},"next":{"fields":{"slug":"/2020/release-blink-mavencentral/2020-12-05-releasing-blink-to-the-maven-central/"},"frontmatter":{"title":"Releasing Blink to Maven Central"}}},"pageContext":{"id":"98165466-078a-52ba-837c-0b8f560a3879","previousPostId":"aad0c412-9d99-5f5c-a22e-33f2f1b86dda","nextPostId":"34edbb42-60f0-5cee-a335-6101da067a68"}},"staticQueryHashes":["2841359383","916993862"]}