{"componentChunkName":"component---src-templates-blog-post-js","path":"/2020/butterfly-bug-fix/2020-11-22-butterfly-bug-fixed/","result":{"data":{"site":{"siteMetadata":{"title":"Blog of Badal Sarkar"}},"markdownRemark":{"id":"c45217c6-6b02-522b-b862-f168eca93783","excerpt":"I have been trying to fix a bug in my code which I was writing to implement a\nnew feature in PayPal/Butterfly. I have written about the bug here. I have finally…","html":"<p>I have been trying to fix a bug in my code which I was writing to implement a\nnew feature in PayPal/Butterfly. I have written about the bug <a href=\"https://badalsarkar.ca/blog-opensource/new-feature-butterfly/\">here</a>.</p>\n<p>I have finally uncovered the cause of the problem and it was a silly\none. To quickly recap, I was implementing Log4j2 as logging framework and there\nI was using <code class=\"language-text\">System.setOut()</code> method to assign File object as standard output.\nSo, when I write <code class=\"language-text\">System.out.println()</code>, in stead of printing to console, it\nwill print in the file. The problem was that the output was not going to the\nfile. Log4j2 has a specific attribute for <code class=\"language-text\">ConsoleAppender</code> to activate\nreassignment of standard output. It is called <code class=\"language-text\">follow</code>. Following screenshot\ntaken from documentation.</p>\n<span class=\"gatsby-resp-image-wrapper\" style=\"position: relative; display: block; margin-left: auto; margin-right: auto; max-width: 630px; \">\n      <a class=\"gatsby-resp-image-link\" href=\"/static/20449e27d63b6f7aaa55c992555558a6/5e3a3/follow.png\" style=\"display: block\" target=\"_blank\" rel=\"noopener\">\n    <span class=\"gatsby-resp-image-background-image\" style=\"padding-bottom: 16.455696202531648%; position: relative; bottom: 0; left: 0; background-image: url(&apos;data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAABQAAAADCAYAAACTWi8uAAAACXBIWXMAAAsSAAALEgHS3X78AAAAjklEQVQI1zWO4Q6EIAyDff9HPBHPSIABxvMXxKi9bZEmzb4t0HTYtg21Voju+8a+7/i99t4j54wQAkopiDEipcxOKHL3AcQ34fM8NWMQkKAu3a+LPxE+44h1dbDTBGMMnHM6ZbfWYp5nTMxfnsuyoLWGoQc9z6PuOo5DmxElJCLmyEzauE9pLG+EW21a5g/wQ+MYtjvtHgAAAABJRU5ErkJggg==&apos;); background-size: cover; display: block;\"></span>\n  <img class=\"gatsby-resp-image-image\" alt=\"follow\" title=\"follow\" src=\"/static/20449e27d63b6f7aaa55c992555558a6/f058b/follow.png\" srcset=\"/static/20449e27d63b6f7aaa55c992555558a6/c26ae/follow.png 158w,\n/static/20449e27d63b6f7aaa55c992555558a6/6bdcf/follow.png 315w,\n/static/20449e27d63b6f7aaa55c992555558a6/f058b/follow.png 630w,\n/static/20449e27d63b6f7aaa55c992555558a6/5e3a3/follow.png 763w\" sizes=\"(max-width: 630px) 100vw, 630px\" style=\"width:100%;height:100%;margin:0;vertical-align:middle;position:absolute;top:0;left:0;\" loading=\"lazy\">\n  </a>\n    </span>\n<br>\nI never noticed it in the documentation and spent many hours trying different\nthings. After the fix the code looks like below-\n<div class=\"gatsby-highlight\" data-language=\"xml\"><pre style=\"counter-reset: linenumber NaN\" class=\"language-xml line-numbers\"><code class=\"language-xml\"><span class=\"token tag\"><span class=\"token tag\"><span class=\"token punctuation\">&lt;</span>Console</span> <span class=\"token attr-name\">name</span><span class=\"token attr-value\"><span class=\"token punctuation attr-equals\">=</span><span class=\"token punctuation\">\"</span>CONSOLE<span class=\"token punctuation\">\"</span></span> <span class=\"token attr-name\">target</span><span class=\"token attr-value\"><span class=\"token punctuation attr-equals\">=</span><span class=\"token punctuation\">\"</span>SYSTEM_OUT<span class=\"token punctuation\">\"</span></span> <span class=\"token attr-name\">follow</span><span class=\"token attr-value\"><span class=\"token punctuation attr-equals\">=</span><span class=\"token punctuation\">\"</span>true<span class=\"token punctuation\">\"</span></span><span class=\"token punctuation\">></span></span>\n    <span class=\"token tag\"><span class=\"token tag\"><span class=\"token punctuation\">&lt;</span>PatternLayout</span> <span class=\"token attr-name\">pattern</span><span class=\"token attr-value\"><span class=\"token punctuation attr-equals\">=</span><span class=\"token punctuation\">\"</span>%msg%n<span class=\"token punctuation\">\"</span></span> <span class=\"token punctuation\">/></span></span>\n<span class=\"token tag\"><span class=\"token tag\"><span class=\"token punctuation\">&lt;/</span>Console</span><span class=\"token punctuation\">></span></span></code><span aria-hidden=\"true\" class=\"line-numbers-rows\" style=\"white-space: normal; width: auto; left: 0;\"><span></span><span></span><span></span></span></pre></div>\n<p>Now, all the tests are passing.</p>\n<h3>Configure Loggers for Asynchronous Logging</h3>\n<p>Butterfly wanted to use Log4j2 because of its <a href=\"https://logging.apache.org/log4j/2.x/manual/async.html\">asynchronous\nlogging</a> feature. The\nperformance benefit of asynchronous logging is massive. Following graph gives\nan idea.</p>\n<p><span\n      class=\"gatsby-resp-image-wrapper\"\n      style=\"position: relative; display: block; margin-left: auto; margin-right: auto; max-width: 630px; \"\n    >\n      <a\n    class=\"gatsby-resp-image-link\"\n    href=\"/static/7ce2a8629b5910bce30f3aa763152fb5/e2310/log4j.png\"\n    style=\"display: block\"\n    target=\"_blank\"\n    rel=\"noopener\"\n  >\n    <span\n    class=\"gatsby-resp-image-background-image\"\n    style=\"padding-bottom: 53.16455696202532%; position: relative; bottom: 0; left: 0; background-image: url('data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAABQAAAALCAYAAAB/Ca1DAAAACXBIWXMAAAsSAAALEgHS3X78AAABwElEQVQoz41SaW/bMAz1//8/+TIMLTxgLTpki9OuWOPF8SVfSxwfceQ7r6Q2o26LAhNA06Kop8dHal3XoW1bjOOIKIpg27Yyy7Lg+77yjuPA8zyYpqn22+0Wm80GRVGg73t1n3GklNAwW2VZ4ng8Ik1T5HmO9XqNxWIBwzCg6zqWyyWB5EiSBDE9ziDz1TQNtDiO1c8wDLhcLq8S+OXz+Yy6rlGRZ4BhfMnhO8yQjStUgFwWU50fTsYxTnyxAfo6QE/x/JjBotJd11WSnE4nRUATQnwIOLfun/+09MkP6FpJ0hxUBVNlXMl/A450zjmffwgFzouBJnsHyK9+xIqtktzJ/hXg26U0FEFAyFIx6LuJzV9G9CFWfHnE9SpAWkhcGwFp1SnNsizD4XBQU8F7Ll8xzIoKdUNNIOE7YppXLZJMwopK/MklWY0vDzHSssGVEaKlHJ5LnsXdbqeast/vFahWywrf72083q3wyxQQloObm58wf/u4/fqAJ9PH6tsjbu+eEGxtXOn3KJOIQHucq0rpOh8zjcchy3L4jo0wjCA8FwGNUhQGFHMQBgK+a0NQzKMcj2IxnU1NZBDWjj0zfAa/qEaQwxl1NgAAAABJRU5ErkJggg=='); background-size: cover; display: block;\"\n  ></span>\n  <img\n        class=\"gatsby-resp-image-image\"\n        alt=\"Log4j2 asynchronous logging performance\"\n        title=\"Log4j2 asynchronous logging performance\"\n        src=\"/static/7ce2a8629b5910bce30f3aa763152fb5/f058b/log4j.png\"\n        srcset=\"/static/7ce2a8629b5910bce30f3aa763152fb5/c26ae/log4j.png 158w,\n/static/7ce2a8629b5910bce30f3aa763152fb5/6bdcf/log4j.png 315w,\n/static/7ce2a8629b5910bce30f3aa763152fb5/f058b/log4j.png 630w,\n/static/7ce2a8629b5910bce30f3aa763152fb5/40601/log4j.png 945w,\n/static/7ce2a8629b5910bce30f3aa763152fb5/e2310/log4j.png 968w\"\n        sizes=\"(max-width: 630px) 100vw, 630px\"\n        style=\"width:100%;height:100%;margin:0;vertical-align:middle;position:absolute;top:0;left:0;\"\n        loading=\"lazy\"\n      />\n  </a>\n    </span></p>\n<p>Image taken from <a href=\"https://logging.apache.org/log4j/2.x/manual/async.html\">https://logging.apache.org/log4j/2.x/manual/async.html</a></p>\n<p>So, next I needed to configure the loggers for asynchronous logging. I followed\nthe <a href=\"https://logging.apache.org/log4j/2.x/manual/async.html\">documentation</a> and\nmy configuration looks like below-</p>\n<div class=\"gatsby-highlight\" data-language=\"xml\"><pre style=\"counter-reset: linenumber NaN\" class=\"language-xml line-numbers\"><code class=\"language-xml\"><span class=\"token prolog\">&lt;?xml version=\"1.0\" encoding=\"UTF-8\"?></span>\n<span class=\"token tag\"><span class=\"token tag\"><span class=\"token punctuation\">&lt;</span>configuration</span><span class=\"token punctuation\">></span></span>\n  <span class=\"token tag\"><span class=\"token tag\"><span class=\"token punctuation\">&lt;</span>Appenders</span><span class=\"token punctuation\">></span></span>\n    <span class=\"token tag\"><span class=\"token tag\"><span class=\"token punctuation\">&lt;</span>Console</span> <span class=\"token attr-name\">name</span><span class=\"token attr-value\"><span class=\"token punctuation attr-equals\">=</span><span class=\"token punctuation\">\"</span>CONSOLE<span class=\"token punctuation\">\"</span></span> <span class=\"token attr-name\">target</span><span class=\"token attr-value\"><span class=\"token punctuation attr-equals\">=</span><span class=\"token punctuation\">\"</span>SYSTEM_OUT<span class=\"token punctuation\">\"</span></span> <span class=\"token attr-name\">follow</span><span class=\"token attr-value\"><span class=\"token punctuation attr-equals\">=</span><span class=\"token punctuation\">\"</span>true<span class=\"token punctuation\">\"</span></span><span class=\"token punctuation\">></span></span>\n      <span class=\"token tag\"><span class=\"token tag\"><span class=\"token punctuation\">&lt;</span>PatternLayout</span> <span class=\"token attr-name\">pattern</span><span class=\"token attr-value\"><span class=\"token punctuation attr-equals\">=</span><span class=\"token punctuation\">\"</span>%msg%n<span class=\"token punctuation\">\"</span></span> <span class=\"token punctuation\">/></span></span>\n    <span class=\"token tag\"><span class=\"token tag\"><span class=\"token punctuation\">&lt;/</span>Console</span><span class=\"token punctuation\">></span></span>\n    <span class=\"token tag\"><span class=\"token tag\"><span class=\"token punctuation\">&lt;</span>Routing</span> <span class=\"token attr-name\">name</span><span class=\"token attr-value\"><span class=\"token punctuation attr-equals\">=</span><span class=\"token punctuation\">\"</span>Routing<span class=\"token punctuation\">\"</span></span><span class=\"token punctuation\">></span></span>\n      <span class=\"token tag\"><span class=\"token tag\"><span class=\"token punctuation\">&lt;</span>Routes</span> <span class=\"token attr-name\">pattern</span><span class=\"token attr-value\"><span class=\"token punctuation attr-equals\">=</span><span class=\"token punctuation\">\"</span>$${sys:logFile}<span class=\"token punctuation\">\"</span></span><span class=\"token punctuation\">></span></span>\n        <span class=\"token tag\"><span class=\"token tag\"><span class=\"token punctuation\">&lt;</span>Route</span><span class=\"token punctuation\">></span></span>\n          <span class=\"token tag\"><span class=\"token tag\"><span class=\"token punctuation\">&lt;</span>RandomAccessFile</span> <span class=\"token attr-name\">name</span><span class=\"token attr-value\"><span class=\"token punctuation attr-equals\">=</span><span class=\"token punctuation\">\"</span>File<span class=\"token punctuation\">\"</span></span> <span class=\"token attr-name\">fileName</span><span class=\"token attr-value\"><span class=\"token punctuation attr-equals\">=</span><span class=\"token punctuation\">\"</span>${sys:logFile}<span class=\"token punctuation\">\"</span></span> <span class=\"token attr-name\">immediateFlush</span><span class=\"token attr-value\"><span class=\"token punctuation attr-equals\">=</span><span class=\"token punctuation\">\"</span>false<span class=\"token punctuation\">\"</span></span><span class=\"token punctuation\">></span></span>\n            <span class=\"token tag\"><span class=\"token tag\"><span class=\"token punctuation\">&lt;</span>PatternLayout</span><span class=\"token punctuation\">></span></span>\n              <span class=\"token tag\"><span class=\"token tag\"><span class=\"token punctuation\">&lt;</span>pattern</span><span class=\"token punctuation\">></span></span>[%d{HH:mm:ss.SSS}] [%-4level] %msg%n<span class=\"token tag\"><span class=\"token tag\"><span class=\"token punctuation\">&lt;/</span>pattern</span><span class=\"token punctuation\">></span></span>\n            <span class=\"token tag\"><span class=\"token tag\"><span class=\"token punctuation\">&lt;/</span>PatternLayout</span><span class=\"token punctuation\">></span></span>\n          <span class=\"token tag\"><span class=\"token tag\"><span class=\"token punctuation\">&lt;/</span>RandomAccessFile</span><span class=\"token punctuation\">></span></span>\n        <span class=\"token tag\"><span class=\"token tag\"><span class=\"token punctuation\">&lt;/</span>Route</span><span class=\"token punctuation\">></span></span>\n      <span class=\"token tag\"><span class=\"token tag\"><span class=\"token punctuation\">&lt;/</span>Routes</span><span class=\"token punctuation\">></span></span>\n    <span class=\"token tag\"><span class=\"token tag\"><span class=\"token punctuation\">&lt;/</span>Routing</span><span class=\"token punctuation\">></span></span>\n  <span class=\"token tag\"><span class=\"token tag\"><span class=\"token punctuation\">&lt;/</span>Appenders</span><span class=\"token punctuation\">></span></span>\n\n  <span class=\"token tag\"><span class=\"token tag\"><span class=\"token punctuation\">&lt;</span>Loggers</span><span class=\"token punctuation\">></span></span>\n    <span class=\"token tag\"><span class=\"token tag\"><span class=\"token punctuation\">&lt;</span>AsyncLogger</span> <span class=\"token attr-name\">name</span><span class=\"token attr-value\"><span class=\"token punctuation attr-equals\">=</span><span class=\"token punctuation\">\"</span>com.paypal.butterfly.cli<span class=\"token punctuation\">\"</span></span> <span class=\"token attr-name\">level</span><span class=\"token attr-value\"><span class=\"token punctuation attr-equals\">=</span><span class=\"token punctuation\">\"</span>INFO<span class=\"token punctuation\">\"</span></span><span class=\"token punctuation\">></span></span>\n      <span class=\"token tag\"><span class=\"token tag\"><span class=\"token punctuation\">&lt;</span>AppenderRef</span> <span class=\"token attr-name\">ref</span><span class=\"token attr-value\"><span class=\"token punctuation attr-equals\">=</span><span class=\"token punctuation\">\"</span>CONSOLE<span class=\"token punctuation\">\"</span></span> <span class=\"token punctuation\">/></span></span>\n    <span class=\"token tag\"><span class=\"token tag\"><span class=\"token punctuation\">&lt;/</span>AsyncLogger</span><span class=\"token punctuation\">></span></span>\n    <span class=\"token tag\"><span class=\"token tag\"><span class=\"token punctuation\">&lt;</span>AsyncRoot</span> <span class=\"token attr-name\">level</span><span class=\"token attr-value\"><span class=\"token punctuation attr-equals\">=</span><span class=\"token punctuation\">\"</span>ERROR<span class=\"token punctuation\">\"</span></span><span class=\"token punctuation\">></span></span>\n      <span class=\"token tag\"><span class=\"token tag\"><span class=\"token punctuation\">&lt;</span>AppenderRef</span> <span class=\"token attr-name\">ref</span><span class=\"token attr-value\"><span class=\"token punctuation attr-equals\">=</span><span class=\"token punctuation\">\"</span>Routing<span class=\"token punctuation\">\"</span></span> <span class=\"token punctuation\">/></span></span>\n    <span class=\"token tag\"><span class=\"token tag\"><span class=\"token punctuation\">&lt;/</span>AsyncRoot</span><span class=\"token punctuation\">></span></span>\n  <span class=\"token tag\"><span class=\"token tag\"><span class=\"token punctuation\">&lt;/</span>Loggers</span><span class=\"token punctuation\">></span></span>\n<span class=\"token tag\"><span class=\"token tag\"><span class=\"token punctuation\">&lt;/</span>configuration</span><span class=\"token punctuation\">></span></span></code><span aria-hidden=\"true\" class=\"line-numbers-rows\" style=\"white-space: normal; width: auto; left: 0;\"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></pre></div>\n<p>I used <code class=\"language-text\">&lt;AsyncRoot&gt;</code> and  <code class=\"language-text\">&lt;AsyncLogger&gt;</code> to declare the loggers as asynchronous.\nLog4j2 accepts a system property <code class=\"language-text\">log4j2.contextSelector=org.apache.logging.log4j.core.async.AsyncLoggerContextSelector</code>\nto make all the loggers asynchronous. For the asynchronous loggers to work, I had\nto add a new dependency <a href=\"https://github.com/LMAX-Exchange/disruptor\">LMAX Disruptor</a>.\nThis one is high performance inter-thread messaging library which uses lock-free\ninter-thread communication instead of queues. I need to know more about it.\nSo, that was all for configuring async logger. Time to test.</p>\n<p>When I ran the tests, four test cases were failing. Not again!!</p>\n<p>This time though, I figured it out quickly. As the loggers were asynchronous and\nthe test cases were written for testing synchronous code, they failed. I don’t\nknow how to write test for asynchronous code using\n<a href=\"https://testng.org/doc/\">TestNG</a>, the testing framework Butterfly is\nusing. Using <code class=\"language-text\">Thread.sleep()</code> is not going to work as there were integration\ntests and I can’t tell for sure where to put <code class=\"language-text\">Thread.sleep()</code>.  Moreover, it is\nnot a good practice for testing asynchronous code. After googling for a while, I\nfound that often for testing purpose a separate configuration is used, a\nsynchronous configuration. So, I decided to create a separate configuration file\nnamed <code class=\"language-text\">log4j2-test.xml</code> where all the loggers are synchronous. The file name is\nvery specific as Log4j2 looks for file with exact name and uses this\nconfiguration for testing purpose. The file needs to be on the classpath. Run\nthe test again and all green.</p>\n<p>Next, I organized my commits using <code class=\"language-text\">git rebase</code> and created a <a href=\"https://github.com/paypal/butterfly/pull/367\">pull\nrequest</a>. All checks of TravisCI\npassed. Now waiting for the maintainer to review my code and do any modification\nhe asks.</p>","frontmatter":{"title":"PayPal/Butterfly Bug Fixed, Finally","date":"November 22, 2020","description":null}},"previous":{"fields":{"slug":"/2020/new-feature-butterfly/2020-11-21-new-feature-butterfly/"},"frontmatter":{"title":"Implementing New Feature in Paypal/Butterfly"}},"next":{"fields":{"slug":"/2020/release-04-planning/2020-11-25-release-04-planning/"},"frontmatter":{"title":"Release 0.4: Planning"}}},"pageContext":{"id":"c45217c6-6b02-522b-b862-f168eca93783","previousPostId":"be590607-bce0-5221-9b21-b41fcfa398ed","nextPostId":"fbba5e8b-e5ff-557b-b477-54fe87a5677e"}},"staticQueryHashes":["2841359383","916993862"]}